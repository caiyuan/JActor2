<html>
<title>Batched Messages per Second</title>
</head>
<body>
<p>
<a href="https://github.com/laforge49/JActor2#readme">JActor2</a> &gt; <a href="../../index.html">Docs</a> &gt; <a href="../index.html">Tutorials</a> &gt; <a href="index.html">Core</a> &gt; Batcher
</p>
<h1>Batcher - Batched Messages per Second</h1>
<p>
As moving messages between blades is sometimes quite slow, 
the send method provides for message batching where multiple
messages sent to the same destination are sent together in a group.
This is illustrated by <a href="java7/Batcher.java">Batcher</a>.
</p>
<pre>
import org.agilewiki.jactor2.core.blades.NonBlockingBladeBase;
import org.agilewiki.jactor2.core.impl.Plant;
import org.agilewiki.jactor2.core.requests.AOp;
import org.agilewiki.jactor2.core.requests.SOp;
import org.agilewiki.jactor2.core.requests.AsyncResponseProcessor;
import org.agilewiki.jactor2.core.reactors.NonBlockingReactor;
import org.agilewiki.jactor2.core.requests.impl.AsyncRequestImpl;

public class Batcher extends NonBlockingBladeBase {
    private final long count;
    private final Ponger ponger;
    
    public Batcher(final NonBlockingReactor _reactor, final long _count, final Ponger _ponger) {
        super(_reactor);
        count = _count;
        ponger = _ponger;
    }
    
    public AOp&lt;Void&gt; runAOp() {
        return new AOp&lt;Void&gt;("run", getReactor()) {
            protected void processAsyncOperation(final AsyncRequestImpl _asyncRequestImpl, 
                    final AsyncResponseProcessor&lt;Void&gt; _asyncResponseProcessor) throws Exception {
                final AsyncResponseProcessor&lt;Long&gt; pingResponseProcessor = 
                        new AsyncResponseProcessor&lt;Long&gt;() {
                    long i = 0;
                
                    @Override
                    public void processAsyncResponse(final Long _response) throws Exception {
                        i++;
                        if (i == count)
                            _asyncResponseProcessor.processAsyncResponse(null);
                    }
                };
            
                SOp&lt;Long&gt; pingSOp = ponger.pingSOp();
                long j = 0;
                while(j &lt; count) {
                    j++;
                    _asyncRequestImpl.send(pingSOp, pingResponseProcessor);
                }
            }
        };
    }
    
    public static void main(final String[] _args) throws Exception {
        final int count = 10000;
        Plant plant = new Plant();
        try {
            Ponger ponger = new Ponger(new NonBlockingReactor(1000, count));
            Batcher batcher = new Batcher(new NonBlockingReactor(1000, count), count, ponger);
            AOp&lt;Void&gt; runAOp = batcher.runAOp();
            final long before = System.nanoTime();
            for (int i = 0; i &lt; 10000; i++) 
                runAOp.call();
            final long after = System.nanoTime();
            final long duration = after - before;
            SpeedReport.print("Batch Timings", duration, count * 10000);
        } finally {
            plant.close();
        }
    }
}
   
Output:

Batch Timings
Test duration in nanoseconds: 40976103298
Number of exchanges: 100000000
Exchanges per second: 2440446
Latency in seconds: 4.0976103298E-7
</pre>
<p>
The code that drives this is fairly simple. We put the send invocation in a simple loop,
which means that all the requests will be sent out at one time, when the loop completes:
</p>
<pre>
            protected void processAsyncOperation(final AsyncRequestImpl _asyncRequestImpl, 
                    final AsyncResponseProcessor&lt;Void&gt; _asyncResponseProcessor) throws Exception {
                ...
            
                SOp&lt;Long&gt; pingSOp = ponger.pingSOp();
                long j = 0;
                while(j &lt; count) {
                    j++;
                    _asyncRequestImpl.send(pingSOp, pingResponseProcessor);
                }
            }
</pre>
<p>
After the requests have been sent, the responses are counted. When 
all the responses have been received, a result of null is returned:
</p>
<pre>
                final AsyncResponseProcessor&lt;Long&gt; pingResponseProcessor = 
                        new AsyncResponseProcessor&lt;Long&gt;() {
                    long i = 0;
                
                    @Override
                    public void processAsyncResponse(final Long _response) throws Exception {
                        i++;
                        if (i == count)
                            _asyncResponseProcessor.processAsyncResponse(null);
                    }
                };
</pre>
<p>
An alternate constructor for the reactor is also used which lets us set the initial sizes
of some internal structures:
</p>
<pre>
            Ponger ponger = new Ponger(new NonBlockingReactor(1000, count));
            Batcher batcher = new Batcher(new NonBlockingReactor(1000, count), count, ponger);
</pre>
</body>
</html>
